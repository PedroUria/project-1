---
title: "project1"
author: "zbuckley, pedrouria, seanpili"
date: "October 13, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##Helper Functions here for cleanly handling imports
#install_all - function for installing all packages in a list that aren't available
#  inspired by https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them
#  ex: install_all(c('readr', 'dplyr'))
install_all <- function(list.of.packages) {
  need_install <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
  if(length(need_install)) install.packages(need_install)
}

# package_apply_all - function for calling install_all on list of packages, then applying a function to them
#  inspired by https://stackoverflow.com/questions/8175912/load-multiple-packages-at-once
#  ex: package_apply_all(c('readr', 'dplyr'), require)
package_apply_all <- function(list.of.packages, func) {
  install_all(list.of.packages)
  invisible(lapply(list.of.packages, func, character.only = TRUE))
}

#resolve dependencies required for the document to run
#https://stackoverflow.com/questions/12984991/stop-lapply-from-printing-to-console
package_apply_all(c('dplyr', # used throughout
                    'readr', # load in the dataframe
                    'ggplot2', # used for 'prettier' graphs
                    'psych', # used for summary statistics information
                    'corrplot', # used for building correlation plots
                    'VIM', # used for determining where missing values are
                    'mice' # used for imputing missing values
                    ), require)

```

# Load Telco Data

The following code will load in the Telco Dataset, and setup the variable types appropriately. 

```{r initial_data_load}
#https://github.com/tidyverse/readr/issues/530
telco <- read_csv('WA_Fn-UseC_-Telco-Customer-Churn.csv',
                  col_types = cols()) %>%
  # Change all character-type variables to factor variables
  # Implementation Inspired by:
  #   https://stackoverflow.com/questions/27668266/dplyr-change-many-data-types
  #   https://gist.github.com/ramhiser/93fe37be439c480dc26c4bed8aab03dd#file-character2factor-r-L8 
  mutate_if(sapply(., is.character), as.factor) %>%
  mutate(
    # Senior Citizen is coded numerically (0,1), and indicates if someone is a senior citizen, 
    # so we switched it's type to factor, and labelled it accordingly.
    SeniorCitizen = factor(SeniorCitizen, labels = c('No', 'Yes')),
    # CustomerID was converted to factor by the blanket mutate_if above, 
    # but has too many levels to be a factor variable, so we'll convert it 
    # back to a character variable.
    customerID = as.character(customerID)
  )

str(telco)
```

# Original Research Question

Is a customer's decision to Churn independent of the type of contract a customer holds, the customer's tenure, and the customers monthly charges?

## Null Hypotheses

1. Customer's Decision to Churn and the type of contract a customer holds are independent. 
2. There is no difference in the mean tenture for Customers who decided to Churn, and those who did not decide to Churn. $\mu_{Churned}-\mu_{Not Churned}=0$
3. There is no difference in the mean monthly charges for Customers who decided to Churn, and those who did no decide to Churn. 

## Alternative Hypotheses

1. Customer's Decision to Churn and the type of contract a customer holds are not independent.
2. There is a significant difference in the mean tenure for Customers who decided to Churn, and those who did not decide to Churn. $\mu_{Churned}-\mu_{Not Churned}\neq0$
3. There is a significant difference in the mean monthly charges for Customers who decided to Churn, and those who did no decide to Churn.

# Conducting Exploratory Data Analysis

> a. Conduct Exploratory Data Analysis that will begin to answer your question, this
> can include for example:
> i. Summary of the dataset/Descriptive Statistics
> ii. Graphical representations of the data

## Corplot and Descriptives

First, let's start with some general descriptive statistics and broad comparisons of the variables:

### Continuous Variables

```{r}
telcon <- telco %>% 
  select_if(
    sapply(telco, is.numeric))
describe(telcon)

# corplot of numeric variables
M <- cor(telcon)
corrplot(M, method='number')
```

Interestingly, all of our numeric variables have a rather large standard deviation compared to their respective means and ranges, especially for the Total Charges variable.
additionally, the meean is roughly 1.6x larger than the median.

This makes sense though, because customers have different combinations  of services, leading to custom variations in each customers Monthly Charges. The longer customers stay with the company, the more the variations in Average Charges expand on the Variance in Total Charges. In fact, it's quite likely that the variance linearly increases as the tenure of customers increase. 

Tenure should probably a have high standard deviation, as it's time driven. We expect that as long as customers continue to stay, tenure would only increase. Thus the right skewed-ness we see represented by the describe output. 

The corrplot of tenure, MonthlyCharges and TotalCharges, shows that there may be a trend between tenure and MonthlyCharges. The '?'s indicate that there are missing TotalCharges values. Let's see if we can impute the missing values and try building the corrplot again. First, we'll need a better understanding of where the missing values are, as it will inform our imputation method. 

```{r}
# https://www.r-bloggers.com/imputing-missing-data-with-r-mice-package/
aggr_plot <- aggr(telcon, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
```

So we can see that the missing values are restricted to TotalCharges, and aren't exceptionally dense. Let's impute the values using mice, and recompute the corrplot. 

```{r}
# Since the missing data isn't very dense:
#  Using default parameters for mice
#  Immediately completing the dataframe
telcon.imputed <- complete(mice(data = telcon))

# recompute aggr_plot
aggr_plot.imputed <- aggr(telcon.imputed, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
```

Excellent. telcon.imputed has no missing values. 

```{r}
M.imputed <- cor(telcon.imputed)
corrplot(M.imputed, method = "number")
```

Now with the completed corrplot of the numeric values in our data, we see that there is a strong correlation between tenure, and TotalCharges. This actually makes a lot of sense, as we'd expect both fields to increase every month, usually by the same set rate as customers stay with the company for more time.

There is also some correlation between Monthly Charges and TotalCharges, which fits our assumptions as to how TotalCharges would nominally be calculated.  

A simple approximation of TotalCharges should be (${TotalCharges}={tenure}*{MonthlyCharges}$), but it is only an approximation because we can't assume that the customers monthly charges stay constant over time. We have to remember we're looking at these values at a given snapshot in time.

Lets apply the equation and plot this for fun: 
```{r}
telco.computedCharges <- telco %>% 
  mutate(
    computedCharges = tenure*MonthlyCharges
  )
plot(x=telco.computedCharges$computedCharges, y=telco.computedCharges$TotalCharges, 
     xlab = "Computed Charges", ylab = "Total Charges", main = "Total vs Computed Charges")
abline(0,1,col = 'Red', lwd=3)
```

As expected, this is pretty good approximation, but there is some variance, explained by us only having access to data given at a snapshot in time. 

### Categorical Variables

```{r}
telcoc <- telco %>% select_if(
  sapply(., is.factor)
)
str(telcoc)
```

Lots of variables.. describe probably won't help much here, so lets move straight to corrplots. 

```{r}
# we'll need to force the factor variables into numeric variables temporarily
telcoc.num <- telcoc %>% mutate_if(sapply(., is.factor), as.numeric)
M <- cor(telcoc.num)
corrplot(M, method = "ellipse")
```

Since we'll be most interested in variables affecting Churn, so lets look at those. In order of most significant correlation:

1.  Contract Type
2.  Online Security
3.  Tech Support 
4.  Online Backup
5.  Paperless Billing
6.  Device Protection
7.  Dependents
8.  Partner
9.  Senior Citizen
10. Payment Method

### Combined Corrplot

We'll need to convert all variables to be numeric, and see if the corrplot gives us something useful. 

```{r}
# Dropping unique ID values in customerID column for this.
telco.num <- select(telco, -customerID) %>%
  mutate_if(
    # force remaining columns to be numeric types
    sapply(., function(x) !is.numeric(x)),
    as.numeric)
str(telco.num)
```

We'll probably need to impute the values in TotalCharges again, but lets double check. 

```{r}
aggr_plot <- aggr(telco.num, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
```

As expected, the only values missing are still in the totalCharges column, let's use mice to impute the values as before, and build the corplot.

```{r}
telco.num.imputed <- complete(mice(data = telco.num))
aggr_plot <- aggr(telco.num.imputed, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
```

Alright... now for the corrplot:

```{r}
# corplot of numeric variables
M <- cor(telco.num.imputed)
corrplot(M, method='ellipse')
```

Our combined list of the top 10 significantly correlated variables:

1. Contract
2. tenure
3. Online Security
4. Tech Support
5. Online Backup
6. Paperless Billing
7. Monthly Charges
8. Device Protection
9. Dependents
10. Partner

## Individual Variables

Now we'll dig through individual variables and explore how they relate to Churn. 

### Churn

Churn indicates whether a given customer has decided to leave the company this month, or not. 

How many of the customers churned in the given month:

```{r}
ggplot(data=telco)+geom_bar(aes(x=Churn))

# calculate percentage churn
t <- table(telco$Churn)
t[[2]]/(t[[1]]+t[[2]])
```

From the graph we can see that the majority of customers aren't churning, but at the same time we've illustrated why the Churn factors are important to telecom companies. $26%$ of their **total** customers are churning in the given month.

Let's dig into other variables more, to try and understand what causes this.

An interesting question from here would be whether the customers that are churning are customers that have been with the company for a long time, or more customers that have just recently picked up subscriptions:

```{r}
boxplot(tenure~Churn, data = telco)
```

We can see a definite trend toward 'newer' subscribers churning in the boxplot above, but this doesn't necessarily tell the whole story, as it seems to indicate that the majority of subscribers who are churning have been with the company for ~ 1 year. In reality this is a 'mean vs median' issue, that can be illusrated better using a different graphic, but we'll get into that more when discusing tenure.

### Contract Type

There are three kinds of contracts a customer can have, that are mentioned in the telco data. 

```{r}
levels(telco$Contract)
```

So how many customers in the data are using each contract type?

```{r}
ggplot(data=telco) + geom_bar(aes(x=Contract))
```

We can see from the graph that the month-to-month contracts are far more popular than either the one year or two year contracts. But we should also take a look at how many customers using the each contract type are churning in the given month, vs. how many customers using the other contract types are churning. 

Below we provide two charts for doing that:

```{r}
churn_vs_contract_plot = ggplot(data=telco,aes(x=Contract))
churn_vs_contract_plot + geom_bar(aes(fill = Churn))
contract_vs_churn_plot = ggplot(data=telco,aes(x=Churn))
contract_vs_churn_plot + geom_bar(aes(fill=Contract))
```

Visually, the Contract and Churn variables don't seem to be independent, counter to what our hypothesis suggests, but we'll revisit this again with a more rigorous analysis later on. 

It may also be interesting to see what levels of normality in tenure may exist when filtering based on Contract Types. 

```{r}
yrc <- telco %>% 
  filter(
    Contract == "One year" |
      Contract == "Two Year",
    Churn == "Yes"
  )
unique(yrc$tenure)
hist(yrc$tenure)
nrow(yrc)
```

TODO: Need discussion here

```{r}
telco_yes <- telco %>% filter(Churn == "Yes")
telco_no <- telco %>% filter(Churn == "No")

nrow(telco_no)
monthly <- telco %>% 
  filter(
    Contract != "One year",
    Contract != "Two Year"
  )
hist(monthly$tenure)
hist(monthly$MonthlyCharges)
```

TODO: Need discussion here

### Tenure

Tenure is a continuous variable representing the time (in months) that a customer has been with the company. 

Is it normally distributed?

```{r}
hist(telco$tenure)
qqnorm(telco$tenure)
qqline(telco$tenure)
```

No need to do any further testing here, this is clearly not a normally distributed variable, based on visual inspection of the histogram and qqplot mechanisms.

The histogram of the tenure data seems to indicate a large amount of newer customers relative to the number of customers that have long-running accounts. But it’s hard to say if this is a recent trend or caused by the ongoing churn that the company is interesting in predicting.

That being said, we expected the graph to show a negative linear pattern where the number of customers who have stayed with telco has steadily declined over the years… but that isn’t the case. There are more customers that joined in the last 5 months than any other 5 month interval in the data, but it appears to level out after about 25 months and then rises again after 5 years. This is good news for the company, as there appears to be a solid core of happy long-term customers.

Lets look at tenure filtered based on Churn. 

```{r}
hist(telco_yes$tenure)
```

Nope. The histogram above shows the same trend we saw when looking at Churn earlier. It appears that more of the Churning behavior is occuring in the most recently added customers.  

```{r}
telco_yes_less <- telco_yes %>% filter(tenure <= 10)
nrow(telco_yes_less)/nrow(telco_yes)
```

Indeed, over 51% of the customers that churned in the given month started their subscriptions within the previous 10 months.

```{r}
hist(telco_no$tenure)
```

Relative to the overall histogram for tenure above, we can see the spike of new customers has dissapeared. It is also extremely interesting that the chart above seems to imply that either a much smaller number of customers was joining the service about 40 months ago, or that the company may have experienceing a higher higher rate of churn during that period. It is hard to say given the information available in this dataset, but would likely be worth pursuing further. 

It may also be interesting to see 'Not Churning', and 'Churning' customers combined in the same graph vs tenure. Here are two variations of that graph.

```{r}
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn))
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn),position='dodge')
```

These charts above require a bit of interpretation, but are quite interesting to look at. 

It appears that most customers who churn do it early, meaning to generally that customers tend to stick around so long as they've been around beyond a certain amount of time. 

The tiny bar where tenure equals 0 appears to represent customers who haven’t been with the company for a full month yet, we aren’t certain why it’s so much smaller than everything else. Speculating, it makes sense that none of these customers have churned because they technically haven’t been billed yet, this might be a hiccup in the data possibly because this data was recording from a larger system part-way through a given month. Potentially, the blib is due to the 'new' contracts in the month during which the data was recorded.

It is important to note, that because of how this chart is laid out, the total number of customers during month 0, can only be calculated by adding up all of the no churn customers from each tenure point. In the process of doing this EDA, we found ourselves accidentally confusing total number of customers x number of months ago, with *the number of customers that joined x number of months ago that haven't churned during month 1*. Which is what a single bar at a given tenure actually tells you.

We can clearly see that of the customers that started with the company during month 1, the majority of them have already Churned as of when the data was recorded in month 0.  

```{r}
month1.no_telco <- telco %>% filter(tenure <= 1, Churn == "No")
month1.all <- telco %>% filter(tenure <= 1)
nrow(month1.no_telco)/nrow(month1.all)

month2.no_telco <- telco %>% filter(tenure == 2, Churn == "No")
month2.all <- telco %>% filter(tenure == 2)
nrow(month2.no_telco)/nrow(month2.all)
```

During the current month, the company only has ~39% of the customers that started using it's services during the previous month. 

Of those customers that started using the companies services 2 months ago, and were still using their services through the previous month, the company has only retained ~48%. 

There appears to be a trend of sorts, lets look at %retention after the previous month / months of service. 

```{r}
ret <- telco %>% group_by(tenure, Churn) %>%
  summarize(n = n()) %>%
  mutate(freq = n/sum(n)) %>%
  filter(Churn == "No")
ret.final = ret[-1,]
scatter.smooth(y=ret.final$freq,
               x= ret.final$tenure,
               xlab = "Customer Tenure",
               ylab = "Rate of Retention",
               main = "Rate of Retention in Current Month\nvs\nCustomer Tenure")

```

This shows a trend that seems to make intuitive sense... 
*Customers that have been with the company longer, are statistically more likely to stay with the company through the current month.* 

Let's also take a look at how tenure and totalCharges are related. We know from the corplot above, that they are correlated: 

```{r}
plot(telco$tenure,telco$TotalCharges,
     main = "Total Charges vs tenure",
     ylab = "Total Charges",
     xlab = "tenure")
```

We can clearly see from this plot why the corplot above called out TotalCharges and tenure as being related. Visually, you see the lower and upper bounding of the monthly charges a customer of the company gets. Most likely due to the variety of service configuration options being offered. 

```{r}
cten_box<-ggplot(telco, aes(x=Churn, y=tenure, color=Churn)) +
  geom_boxplot()
cten_box
```

TODO: Incorporate the boxplot into discussions

### Online Security
TODO

### Tech Support
TODO

### Online Backup
TODO

### Paperless Billing
TODO

### Monthly Charges

Let's check for normality through the histogram and qqplots. 

```{r}
hist(telco$MonthlyCharges)
qqnorm(telco$MonthlyCharges)
qqline(telco$MonthlyCharges)
```

From visual inspection of the histogram and qqplots provided above, we can see that Monthly Charges is not normally distributed. It appears to have 2 different peaks, and as such we likely won't be using ANOVA for analyzing the variance in Monthly Charge samples filtered by Churn... just to be sure though: 

```{r}
ggplot(telco, aes(x=Churn, y=MonthlyCharges, color=Churn)) +
  geom_boxplot()

boxplot(MonthlyCharges~Churn, data=telco, xlab='Churn', ylab='Monthly Charges($)', main='Monthly Charges by Churn')
ggplot(data=telco)+geom_bar(aes(x=MonthlyCharges, fill=Churn),position='dodge')

hist(telco_no$MonthlyCharges)
qqnorm(telco_no$MonthlyCharges)
qqline(telco_no$MonthlyCharges)

hist(telco_yes$MonthlyCharges)
qqnorm(telco_yes$MonthlyCharges)
qqline(telco_yes$MonthlyCharges)
```

This means ANOVA will not work for comparing variance between the filtered observations of MonthlyCharges, because ANOVA makes assumptions about normally distribed samples, then compares mean and variances between them. 

```{r}
ggplot(telco, aes(x=Churn, y=MonthlyCharges, color=Churn)) +
  geom_boxplot()
```

There does visually appear to be a decent amount of variation between the Churning an non-Churning monthly charge values. But it's hard to say if it is a statistically significant trend in this case.

### Device Protection
TODO

### Dependents
TODO

### Partner
TODO

### Senior Citizen
TODO

### Gender
TODO

### Phone Service
TODO

### Multiple Lines
TODO

### Internet Service
TODO

### Streaming TV
TODO

### Streaming Movies
TODO

### Payment Method
TODO

## Investigating Hypothesis 1

# CUTLINE

### Descriptive Statistics and Graphical Representations - Numerical Data


```{r}
telcon <- telco %>% 
  select_if(
    sapply(telco, is.numeric))
describe(telcon)


plot(telco$tenure,telco$TotalCharges)
summary(lm(TotalCharges~tenure,data=telco))
2283.3/1397.47

```

TODO: Notes/Thoughts/Comments here regarding describe output

# Interestingly, all of our numeric variables have a rather large standard deviation compared to their respective means and ranges, especially for the Total Charges variable. 
# additionally, the meean is roughly 1.6x larger than the median. 

# This makes sense though, because customers have different numbers of services and not all of them pay for tech support or have a warranty, and the longer customers stay with the company, the bigger the differences will be in their total charges. 

# Additionally, we beleive that the rather large standard deviation in Monthly charges is for a similar reason, there are so many combinations of services/warranties that customers can choose to consume. 

# it also makes sense for there to be a rather high standard deviation for the tenure, 
# because the number of people remaining with telco can only decrease, not increase, 
# so it makes sense that the distribution is slightly right skewed.

#### Tenure

Worth noting that the tenure data's average is ~32 months, but with a standard deviation of ~24 months. This amount of variability probably explains why the company is interested in getting a better understanding of their customer churn.

```{r}
#TODO bins of size to match next plot
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn))
# the median tenure of the customers who churned is 1/2 the tenure of customers 
# who didn't churn, 
hist(telco$tenure)
mean(telco_yes$tenure)
mean(telco_no$tenure)

hist(telco_yes$tenure)
hist(telco_no$tenure)
# not surprisingly, the mean tenure of the customers who churned is 1/2 the tenure of customers 
# who didn't churn, 

t.test(telco_yes$tenure,telco_no$tenure,alternative = "two.sided",var.equal = FALSE)

# Since our p-value is much less than .05, we reject H0, the mean tenure of telecom customers who churned (for this company) is different than the mean tenure of the telecom customers who did not churn at the alpha = .05 level of significance. 

# We now have reason to beleive that there is a relationship between whether a customer churns and their tenure, on average. Therefore it makes sense that researchers studying churn rates typically include a customer's tenure in a logistic regression or classificatio model and that it showed predictive power in the models we studied. 


# try it with a srs of 1000 for each population....
yes_sam = sample(telco_yes$customerID,size=1000)
no_sam = sample(telco_no$customerID,size=1000)
yess = telco_yes[which(telco_yes$customerID%in%yes_sam),]
dim(yess)
nos = telco_no[which(telco_no$customerID%in%no_sam),]

yn_sam = rbind(yess,nos)
View(yn_sam)


t.test(yess$tenure,nos$tenure,alternative = "two.sided",var.equal = FALSE)

wilcox.test(tenure~Churn,data=yn_sam)
#summary(tenaov)

# as we can see here, there 
qqnorm(telco$tenure)
qqline(telco$tenure)
cten_box<-ggplot(telco, aes(x=Churn, y=tenure, color=Churn)) +
  geom_boxplot()
cten_box

pap_plot = ggplot(data=telco,aes(x=Churn))
pap_plot + geom_bar(aes(fill=PaperlessBilling))

contract_plot = ggplot(data=telco,aes(x=Churn))
contract_plot + geom_bar(aes(fill=Contract))
table(telco_yes$Contract)

```

Customer tenure for this month is clearly not normally distributed. It appears that relatively a large number of new customers have appeared over the last 5 months, but we have to remember that we have no data on customers who cancelled their service that joined any time in the last 5 years and 10 months.

That is to say, the number of new customers telco signs every month may have been consistent over the last six years, but since we can only see 

That being said, we expected the graph to show a negative linear pattern where the number of customers who have stayed with telco has steadily declined over the years... but that isn't the case. There are more customers that joined in the last 5 months than any other 5 month interval in the data, but it appears to level out after about 25 months and then rises again after 5 years. 



The histogram of the tenure data seems to indicate a large amount of newer customers relative to the number of customers that have long-running accounts. But it's hard to say if this is a recent trend or caused by the ongoing churn that the company is interesting in predicting. 

```{r}
#TODO: so cool. lets see if we can flip it.
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn))
# try stacked v. not-stacked...
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn),position='dodge')
```

The tenure histogram showing Churn Yes/No vs. the amount of tenure a customer has, shows the trend we pretty much expected. We can see that a core of long-term customers seems to stick around..... 

It appears that most customers who churn do it early.

The tiny bar represents customers who haven't been with the company for a full month yet, 
we aren't sure why it's so much smaller than everything else. It makes sense that none of these customers have churned because they technically haven't been billed yet, this might be a hiccup in the data, maybe this analysis was done early in the month and they included 
a handful of new contracts that month. 

TODO: More here #### EDITED, I CHECKED IT OUT
Important: Are we looking at stacked bars or total frequencies (from sean) It's stacked. :) 
Dumber Note: This is not total custermers 40 months ago.... total customers at month 0 is sum of all customers that haven't churned.... careful when writing this up.

#### Monthly Charges

```{r}

### all we need to cahnge here is essentially label the plot 
# we can't use anova bc of what I just showed here... 
hist(telco$MonthlyCharges)
# this data is bimodal.... and slightly skewed but our sample size is large, 
# so we think
hist(telco_no$MonthlyCharges)
hist(telco_yes$MonthlyCharges)
# definitely not normal. 
boxplot(MonthlyCharges~Churn, data=telco, xlab='Churn', ylab='Monthly Charges($)', main='Monthly Charges by Churn')
# this was funny... but no
ggplot(data=telco)+geom_bar(aes(x=MonthlyCharges, fill=Churn))
# definitely skewed to the right. 
hist(telco_yes$MonthlyCharges)
# what we learned is that the customers who ARE churning are definitely paying more $$

# can we do anova here? I'd like too, but have to ask the dependent v. indpendent 
# variable question, besides we have many more customers who have churned. 
# which means... 
qqnorm(telco$MonthlyCharges)
qqline(telco$MonthlyCharges)




# this means we CANNOT use anova, unfortunately. OUr groupmeans are not normal 
#moncaov = aov(MonthlyCharges~Churn,data = telco)
#leveneTest(moncaov)


charge_box<-ggplot(telco, aes(x=Churn, y=MonthlyCharges, color=Churn)) +
  geom_boxplot()

charge_box

t.test(telco_yes$MonthlyCharges,telco_no$MonthlyCharges,alternative = "two.sided",var.equal = FALSE)
dim(nos)
t.test(yess$MonthlyCharges,nos$MonthlyCharges,alternative = "two.sided",var.equal = FALSE)

wilcox.test(MonthlyCharges~Churn,data=yn_sam)

```

This seems to show a general trend of Customers paying more, being more likely to Churn, though there is a lot of variation in MonthlyCharges for Customers that didn't churn, so it may not be a very statistically relevant trend....... 
TODO: More here

#### Total Charges

```{r}
# we can really only look at either monthly charges or total charges when trying to 
# predict Churn, and well... we can't really use one to predict the other bc they are 
# DEFINITELY correlated. 

# we might as well just use 
hist(telco$TotalCharges)
plot(telco$TotalCharges,telco$tenure)
# everyone who is staying longer is going to generally have higher charges 
# simply bc they are charged MORE times..... 

# interestingly, these are closer than we expected, unfortunately we can't run a t-test because our numeric data isn't normal. 
#tcharge_box<-ggplot(telco, aes(x=Churn, y=TotalCharges, color=Churn)) +
#  geom_boxplot()
#tcharge_box

#ggplot(data=telco)+geom_histogram(aes(x=TotalCharges, fill=Churn))
# distribution isn't EXACTLY the same... customers who do churn does have a bit more of an extreme dropoff... but it's similar. 
#ggplot(data=telco_yes)+geom_histogram(aes(x=TotalCharges),fill='blue')+geom_text()

#ggplot(data=telco_no)+geom_histogram(aes(x=TotalCharges),fill='red') 


```

NOT GONNA DELETE THIS BELOW,  BUT NOW THAT WE HAVE THE HISTOGRAMs BROKEN BY CHURN WHICH SHOWS ESSENTIALLY THE SAME DISTRIBUTION FOR BOTH VALUES..... I'M COMMENTING IT OUT AND REPLACING IT WITH THIS. 

The distributions aren't identical, but they are similar. (They are both skewed right but it's more skewed right for customers who churned)
#The histogram of total charges seems to makes sense against the trend we saw before with tenure that indicates the majority of the customers we have in the database recently started with the company (~ <5 months tenure). 

Appears that people who have Churned has spend a little bit less overall, however we did expect a bigger difference in overall spending.

### Descriptive Statistics and Graphical Representations - Categorical Data

```{r}

factors <- unlist(lapply(telco, is.factor))
table(telco$Churn)
table(telco$Churn)[2]/table(telco$Churn)[1]
```

The Churn Rate is 36.122 %
Also, note we decided not to 
TODOS:
 - Table/Graphics for remaining categorical data
```{r}
# ask brian if I should list the realtive frequencies of everything and talk about them in the report? seems kind of agains the point 
```
 
> iii. Measures of Variance

# TODO: may be above... look at summary stats from boxplot stuff above... 

> iv. Initial correlation

# TODO: only applies to numberic data (between total/monthly/tenure)
# TODO: build corrplot and discuss

> b. Select and develop an appropriate model (Chi-square/ANOVA/Regression) to
> address your research question allowing you to either accept or reject the null
> hypothesis. This should include, as appropriate, model evaluation techniques. 

#TODO run chi-squared as appropriate for research question. 

```{r}

  yr = telco[which(telco$Contract=="One year"|telco$Contract=="Two year"),]
  yrc = yr[yr$Churn == "Yes",]
  unique(yrc$tenure)
  hist(yrc$tenure, xlab = "Tenure in Months", main = "Tenure of annual and bi-annual Churners",breaks = c(0:72)*1 )
  max(telco$tenure)
  dim(yrc)
  dim(telco_no)
  
  monthly = telco[which(telco$Contract!="One year"&telco$Contract!="Two year"),]
  unique(monthly$Contract)
  unique(monthly$tenure)
  
  
  contract_tab = table(telco$Contract,telco$Churn)
  contract_test = chisq.test(contract_tab)
  contract_test
  contract_test$observed
  contract_test$expected
  
```

