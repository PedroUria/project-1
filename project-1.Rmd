---
title: "project1"
author: "zbuckley, pedrouria, seanpili"
date: "October 13, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##Helper Functions here for cleanly handling imports
#install_all - function for installing all packages in a list that aren't available
#  inspired by https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them
#  ex: install_all(c('readr', 'dplyr'))
install_all <- function(list.of.packages) {
  need_install <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
  if(length(need_install)) install.packages(need_install)
}

# package_apply_all - function for calling install_all on list of packages, then applying a function to them
#  inspired by https://stackoverflow.com/questions/8175912/load-multiple-packages-at-once
#  ex: package_apply_all(c('readr', 'dplyr'), require)
package_apply_all <- function(list.of.packages, func) {
  install_all(list.of.packages)
  invisible(lapply(list.of.packages, func, character.only = TRUE))
}

#resolve dependencies required for the document to run
#https://stackoverflow.com/questions/12984991/stop-lapply-from-printing-to-console
package_apply_all(c('dplyr', 'readr','ggplot2', 'psych'), require)
```

# Load Data Telco

The following code will load in the Telco Dataset, and setup the variable types appropriately. 

```{r initial_data_load}
#https://github.com/tidyverse/readr/issues/530
telco <- read_csv('WA_Fn-UseC_-Telco-Customer-Churn.csv',
                  col_types = cols()) %>%
  # Implementation Inspired by:
  #   https://stackoverflow.com/questions/27668266/dplyr-change-many-data-types
  #   https://gist.github.com/ramhiser/93fe37be439c480dc26c4bed8aab03dd#file-character2factor-r-L8 
  mutate_if(sapply(., is.character), as.factor) %>%
  mutate(
    # Senior Citizen is coded numerically (0,1), and indicates if someone is a senior citizen, 
    # so we switched it's type to factor, and labelled it accordingly.
    SeniorCitizen = factor(SeniorCitizen, labels = c('No', 'Yes')),
    # CustomerID was converted to factor by the blanket mutate_if above, 
    # but has too many levels to be a factor variable, so we'll convert it 
    # back to a character variable.
    customerID = as.character(customerID)
  )

str(telco)
```

# Original Research Question

Is a customer's decision to Churn independent of the type of contract a customer holds, and is customer's tenure.

## Null Hypotheses

1. Customer's Decision to Churn and the type of contract a customer holds are independent. 
2. There is no difference in the mean tenture for Customers who decided to Churn, and those who did not decide to Churn. $\mu_{Churned}-\mu_{Not Churned}=0$
3. There is no difference in the mean monthly charges for Customers who decided to Churn, and those who did no decide to Churn. 

## Alternative Hypotheses

1. Customer's Decision to Churn and the type of contract a customer holds are not independent.
2. There is a significant difference in the mean tenure for Customers who decided to Churn, and those who did not decide to Churn. $\mu_{Churned}-\mu_{Not Churned}\neq0$
3. There is a significant difference in the mean monthly charges for Customers who decided to Churn, and those who did no decide to Churn.

# Conducting Exploratory Data Analysis

> a. Conduct Exploratory Data Analysis that will begin to answer your question, this
> can include for example:
> i. Summary of the dataset/Descriptive Statistics
> ii. Graphical representations of the data

First, let's start with some general descriptive statistics about the numberical fields in our data

```{r}
telcon <- telco %>% 
  select_if(
    sapply(telco, is.numeric))
describe(telcon)
```

## Digging through the variables

### Churn

Churn indicates whether a given customer has decided to leave the company this month, or not. 

How many of the customers churned in the given month:

```{r}
ggplot(data=telco)+geom_bar(aes(x=Churn))

# calculate percentage churn
t <- table(telco$Churn)
t[[2]]/(t[[1]]+t[[2]])
```

From the graph we can see that the majority of customers aren't churning, but at the same time we've illustrated why the Churn factors are important to telecom companies. $26%$ of their customers are churning in a given month. 

An interesting question from here would be whether the customers that are churning are customers that have been with the company for a long time, or more customers that have just recently picked up subscriptions:

```{r}
boxplot(tenure~Churn, data = telco)
```

We can see a definite trend toward 'newer' subscribers churning in the boxplot above, but this doesn't necessarily tell the whole story, as it seems to indicate that the majority of subscribers who are churning have been with the company for ~ 1 year. In reality this is a 'mean vs median' issue, that can be illusrated better using a different graphic, but we'll get into that more when discusing tenure.

### Contract

There are three kinds of contracts a customer can have, that are mentioned in the telco data. 

```{r}
unique(telco$Contract)
```

So how many customers in the data are using each contract type?

```{r}
ggplot(data=telco) + geom_bar(aes(x=Contract))
```

We can see from the graph that the month-to-month contracts are far more popular than either the one year or two year contracts. But we should also take a look at how many customers using the month-to-month contract are churning in the given month, vs. how many customers using the other contract types are churning. 

Below we provide two charts for doing that:

```{r}
churn_vs_contract_plot = ggplot(data=telco,aes(x=Contract))
churn_vs_contract_plot + geom_bar(aes(fill = Churn))
contract_vs_churn_plot = ggplot(data=telco,aes(x=Churn))
contract_vs_churn_plot + geom_bar(aes(fill=Contract))
```

Visually, the Contract and Churn variables don't seem to be independent, as our origin hypothesis suggested, but we'll revisit this again with a more rigorous analysis later on. 

### Tenure

Tenure is a continuous variable representing the time (in months) that a customer has been with the company. 

Is it normally distributed?

```{r}
hist(telco$tenure)
```

No need to do any further testing here, this is clearly not a normally distributed variable. In fact it looks like it's exactly the opposite of a normally distributed variable.

Does that trend stay the same if we group the customers by those that Churned, and those that didn't?

```{r}
telco_yes <- telco %>% filter(Churn == "Yes")
telco_no <- telco %>% filter(Churn == "No")
hist(telco_yes$tenure)
```

The histogram of tenure for customers that have churned, reinforces the trend we saw when looking at Churn before, in that more recently added subscribers are where most of the churning customers are comming from. 

```{r}
telco_yes_less <- telco_yes %>% filter(tenure <= 10)
nrow(telco_yes_less)/nrow(telco_yes)
```

In fact over 51% of the customers that churned, started their subscriptions in the last 10 months.

```{r}
hist(telco_no$tenure)
```

Relative to the overall histogram for tenure above, we can see the spike of new customers has dissapeared. It is also extremely interesting that the chart above seems to imply that either a much smaller number of customers was joining the service about 40 months ago, or they may have had a much higher rate of churn during that period. It is hard to say given the information available in the dataset. 

It may also be intersting to see the not Churning, and Churning customers combined in the same graph vs tenure: 

```{r}
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn))
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn),position='dodge')
```

These charts above require a bit of interpretation, but are quite interesting to look at. 

We can clearly see that more of the customers that started with the company this month cancelled their services than those that stayed with the company. Wow. 

```{r}
month1.no_telco <- telco %>% filter(tenure <= 1, Churn == "No")
month1.all <- telco %>% filter(tenure <= 1)
nrow(month1.no_telco)/nrow(month1.all)

month2.no_telco <- telco %>% filter(tenure == 2, Churn == "No")
month2.all <- telco %>% filter(tenure == 2)
nrow(month2.no_telco)/nrow(month2.all)
```

After this last month, the company only has ~39% of the customers that started using it's services during this last month. 

Of those who were still using it's services the previous month, the company only retained ~48%. 

There appears to be a trend of sorts, lets look at %retention / months of service, for this month. 

```{r}
ret <- telco %>% group_by(tenure, Churn) %>%
  summarize(n = n()) %>%
  mutate(freq = n/sum(n)) %>%
  filter(Churn == "No")
ret.final = ret[-1,]
scatter.smooth(y=ret.final$freq,
               x= ret.final$tenure,
               xlab = "Customer Tenure",
               ylab = "Rate of Retention",
               main = "Rate of Retention vs Customer Tenure")

```

This shows a trend that seems to make intuitive sense... Customers that have been with the company longer, tend to stay with the company. 

In the given month for which we have Churn information we saw this trend playout. 

#### Mean Tunure



### Monthly Charges
#### Mean Monthly Charges

## Investigating Hypothesis 1


# CUTLINE

### Descriptive Statistics and Graphical Representations - Numerical Data


```{r}
telcon <- telco %>% 
  select_if(
    sapply(telco, is.numeric))
describe(telcon)


plot(telco$tenure,telco$TotalCharges)
summary(lm(TotalCharges~tenure,data=telco))
2283.3/1397.47

```

TODO: Notes/Thoughts/Comments here regarding describe output

# Interestingly, all of our numeric variables have a rather large standard deviation compared to their respective means and ranges, especially for the Total Charges variable. 
# additionally, the meean is roughly 1.6x larger than the median. 

# This makes sense though, because customers have different numbers of services and not all of them pay for tech support or have a warranty, and the longer customers stay with the company, the bigger the differences will be in their total charges. 

# Additionally, we beleive that the rather large standard deviation in Monthly charges is for a similar reason, there are so many combinations of services/warranties that customers can choose to consume. 

# it also makes sense for there to be a rather high standard deviation for the tenure, 
# because the number of people remaining with telco can only decrease, not increase, 
# so it makes sense that the distribution is slightly right skewed.

#### Tenure

Worth noting that the tenure data's average is ~32 months, but with a standard deviation of ~24 months. This amount of variability probably explains why the company is interested in getting a better understanding of their customer churn.

```{r}
#TODO bins of size to match next plot
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn))
hist(telco$tenure)
# this means we CANNOT use anova, unfortunately. OUr groupmeans are not normal 
#tenaov = aov(tenure~Churn,data = telco)
#leveneTest(y=telco$tenure,group=telco$Churn)

#summary(tenaov)
qqnorm(telco$tenure)
qqline(telco$tenure)
cten_box<-ggplot(telco, aes(x=Churn, y=tenure, color=Churn)) +
  geom_boxplot()
cten_box

pap_plot = ggplot(data=telco,aes(x=Churn))
pap_plot + geom_bar(aes(fill=PaperlessBilling))

contract_plot = ggplot(data=telco,aes(x=Churn))
contract_plot + geom_bar(aes(fill=Contract))
table(telco_yes$Contract)



```

Customer tenure for this month is clearly not normally distributed. It appears that relatively a large number of new customers have appeared over the last 5 months, but we have to rember that we have no data on customers who cancelled their service that joined any time in the last 5 years and 10 months.

That is to say, the number of new customers telco signs every month may have been consistent over the last six years, but since we can only see 

That being said, we expected the graph to show a negative linear pattern where the number of customers who have stayed with telco has steadily declined over the years... but that isn't the case. There are more customers that joined in the last 5 months than any other 5 month interval in the data, but it appears to level out after about 25 months and then rises again after 5 years. 



The histogram of the tenure data seems to indicate a large amount of newer customers relative to the number of customers that have long-running accounts. But it's hard to say if this is a recent trend or caused by the ongoing churn that the company is interesting in predicting. 

```{r}
#TODO: so cool. lets see if we can flip it.
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn))
# try stacked v. not-stacked...
ggplot(data=telco)+geom_bar(aes(x=tenure, fill=Churn),position='dodge')
```

The tenure histogram showing Churn Yes/No vs. the amount of tenure a customer has, shows the trend we pretty much expected. We can see that a core of long-term customers seems to stick around..... 

It appears that most customers who churn do it early.

The tiny bar represents customers who haven't been with the company for a full month yet, 
we aren't sure why it's so much smaller than everything else. It makes sense that none of these customers have churned because they technically haven't been billed yet, this might be a hiccup in the data, maybe this analysis was done early in the month and they included 
a handful of new contracts that month. 

TODO: More here #### EDITED, I CHECKED IT OUT
Important: Are we looking at stacked bars or total frequencies (from sean) It's stacked. :) 
Dumber Note: This is not total custermers 40 months ago.... total customers at month 0 is sum of all customers that haven't churned.... careful when writing this up.

#### Monthly Charges

```{r}

### all we need to cahnge here is essentially label the plot 
# we can't use anova bc of what I just showed here... 
hist(telco$MonthlyCharges)
# definitely not normal. 
boxplot(MonthlyCharges~Churn, data=telco, xlab='Churn', ylab='Monthly Charges($)', main='Monthly Charges by Churn')
# this was funny... but no
ggplot(data=telco)+geom_bar(aes(x=MonthlyCharges, fill=Churn),position='dodge')
hist(telco_no$MonthlyCharges)
# definitely skewed to the right. 
hist(telco_yes$MonthlyCharges)
# what we learned is that the customers who ARE churning are definitely paying more $$

# can we do anova here? I'd like too, but have to ask the dependent v. indpendent 
# variable question, besides we have many more customers who have churned. 
# which means... 
qqnorm(telco$MonthlyCharges)
qqline(telco$MonthlyCharges)




# this means we CANNOT use anova, unfortunately. OUr groupmeans are not normal 
#moncaov = aov(MonthlyCharges~Churn,data = telco)
#leveneTest(moncaov)


charge_box<-ggplot(telco, aes(x=Churn, y=MonthlyCharges, color=Churn)) +
  geom_boxplot()
charge_box
```

This seems to show a general trend of Customers paying more, being more likely to Churn, though there is a lot of variation in MonthlyCharges for Customers that didn't churn, so it may not be a very statistically relevant trend....... 
TODO: More here

#### Total Charges

```{r}
# we can really only look at either monthly charges or total charges when trying to 
# predict Churn, and well... we can't really use one to predict the other bc they are 
# DEFINITELY correlated. 

# we might as well just use 
hist(telco$TotalCharges)
plot(telco$TotalCharges,telco$tenure)
# everyone who is staying longer is going to generally have higher charges 
# simply bc they are charged MORE times..... 

# interestingly, these are closer than we expected, unfortunately we can't run a t-test because our numeric data isn't normal. 
#tcharge_box<-ggplot(telco, aes(x=Churn, y=TotalCharges, color=Churn)) +
#  geom_boxplot()
#tcharge_box

#ggplot(data=telco)+geom_histogram(aes(x=TotalCharges, fill=Churn))
# distribution isn't EXACTLY the same... customers who do churn does have a bit more of an extreme dropoff... but it's similar. 
#ggplot(data=telco_yes)+geom_histogram(aes(x=TotalCharges),fill='blue')+geom_text()

#ggplot(data=telco_no)+geom_histogram(aes(x=TotalCharges),fill='red') 


```

NOT GONNA DELETE THIS BELOW,  BUT NOW THAT WE HAVE THE HISTOGRAMs BROKEN BY CHURN WHICH SHOWS ESSENTIALLY THE SAME DISTRIBUTION FOR BOTH VALUES..... I'M COMMENTING IT OUT AND REPLACING IT WITH THIS. 

The distributions aren't identical, but they are similar. (They are both skewed right but it's more skewed right for customers who churned)
#The histogram of total charges seems to makes sense against the trend we saw before with tenure that indicates the majority of the customers we have in the database recently started with the company (~ <5 months tenure). 

Appears that people who have Churned has spend a little bit less overall, however we did expect a bigger difference in overall spending.

### Descriptive Statistics and Graphical Representations - Categorical Data

```{r}

factors <- unlist(lapply(telco, is.factor))
table(telco$Churn)
table(telco$Churn)[2]/table(telco$Churn)[1]
```

The Churn Rate is 36.122 %
Also, note we decided not to 
TODOS:
 - Table/Graphics for remaining categorical data
```{r}
# ask brian if I should list the realtive frequencies of everything and talk about them in the report? seems kind of agains the point 
```
 
> iii. Measures of Variance

# TODO: may be above... look at summary stats from boxplot stuff above... 

> iv. Initial correlation

# TODO: only applies to numberic data (between total/monthly/tenure)
# TODO: build corrplot and discuss

> b. Select and develop an appropriate model (Chi-square/ANOVA/Regression) to
> address your research question allowing you to either accept or reject the null
> hypothesis. This should include, as appropriate, model evaluation techniques. 

#TODO run chi-squared as appropriate for research question. 

```{r}

  yr = telco[which(telco$Contract=="One year"|telco$Contract=="Two year"),]
  yrc = yr[yr$Churn == "Yes",]
  unique(yrc$tenure)
  hist(yrc$tenure)
  dim(yrc)
  
  
  monthly = telco[which(telco$Contract!="One year"&telco$Contract!="Two year"),]
  unique(monthly$Contract)
  unique(monthly$tenure)
  
  hist(monthly$tenure)
  hist(monthly$MonthlyCharges)
  shapiro.test(monthly$tenure)
  
```

